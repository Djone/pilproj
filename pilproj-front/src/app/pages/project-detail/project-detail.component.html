<div class="page">
  <div class="header">
    <div>
      <h2>{{ project.intitule }}</h2>
      <p-tag [value]="clientLabel(project.clientId)" severity="info"></p-tag>
    </div>
    <div class="header__actions">
      <p-button label="Retour" icon="pi pi-arrow-left" routerLink="/projets" styleClass="p-button-text"></p-button>
      <p-button label="Ajouter un périmètre" icon="pi pi-plus" (onClick)="openPerimetreDialog()"></p-button>
      <p-button label="Ajouter une affectation" icon="pi pi-user-plus" severity="success" (onClick)="openAffectationDialog()"></p-button>
    </div>
  </div>

  <div class="grid">
    <div class="col-12 md:col-5">
      <p-card header="Périmètres">
        <p-table [value]="perimetres" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th>Nom</th>
              <th>Charge initiale (j)</th>
              <th>Affecté (j)</th>
              <th style="width:120px"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ row.nom }}</td>
              <td>{{ row.chargeInitiale }}</td>
              <td>
                <p-tag
                  [value]="perimetreChargeAffectee(row.id) + ' j'"
                  [severity]="perimetreChargeAffectee(row.id) > row.chargeInitiale ? 'danger' : 'success'"
                ></p-tag>
              </td>
              <td class="actions">
                <p-button icon="pi pi-pencil" text severity="info" (onClick)="openPerimetreDialog(row)"></p-button>
                <p-button icon="pi pi-trash" text severity="danger" (onClick)="deletePerimetre(row.id)"></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

    <div class="col-12 md:col-7">
      <p-card header="Affectations">
        <p-table [value]="affectations" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th>Collaborateur</th>
              <th>Périmètre</th>
              <th>Jours</th>
              <th style="width:140px"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>{{ collaborateurLabel(row.collaborateurId) }}</td>
              <td>{{ perimetreLabel(row.perimetreId) }}</td>
              <td>{{ row.jours }}</td>
              <td class="actions">
                <p-button icon="pi pi-pencil" text severity="info" (onClick)="openAffectationDialog(row)"></p-button>
                <p-button icon="pi pi-trash" text severity="danger" (onClick)="deleteAffectation(row.id)"></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>
  </div>

  <p-divider></p-divider>

  <div class="header">
    <h3>Pool collaborateurs du projet</h3>
    <p-button label="Ajouter un collaborateur" icon="pi pi-user-plus" (onClick)="openCollabDialog()"></p-button>
  </div>
  <p-card>
    <p-table [value]="collaborateursDispo" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Coût (€)</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-row>
        <tr>
          <td>{{ row.nom }}</td>
          <td>{{ row.prenom }}</td>
          <td>{{ row.cout }}</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<p-dialog
  header="{{ editingPerimetreId ? 'Modifier le périmètre' : 'Nouveau périmètre' }}"
  [(visible)]="showPerimetreDialog"
  [modal]="true"
  [style]="{ width: '480px' }"
>
  <div class="form-grid">
    <label>Nom</label>
    <input pInputText type="text" [(ngModel)]="perimetreForm.nom" placeholder="Périmètre" />

    <label>Charge initiale (j)</label>
    <p-inputNumber [(ngModel)]="perimetreForm.chargeInitiale" mode="decimal" inputStyleClass="w-full" [min]="0"></p-inputNumber>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Annuler" icon="pi pi-times" text (onClick)="showPerimetreDialog=false"></p-button>
    <p-button label="Enregistrer" icon="pi pi-check" (onClick)="savePerimetre()" severity="success"></p-button>
  </ng-template>
</p-dialog>

<p-dialog
  [header]="affectationDialogTitle"
  [(visible)]="showAffectationDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
>
  <div class="form-grid">
    <label>Collaborateur</label>
    <p-select
      [options]="collaborateurOptions"
      optionLabel="label"
      optionValue="value"
      [(ngModel)]="affectationForm.collaborateurId"
      placeholder="Choisir un collaborateur"
      styleClass="w-full"
    ></p-select>

    <label>Périmètre</label>
    <p-select
      [options]="perimetreOptions"
      optionLabel="label"
      optionValue="value"
      [(ngModel)]="affectationForm.perimetreId"
      placeholder="Choisir un périmètre"
      styleClass="w-full"
    ></p-select>

    <label>Jours alloués</label>
    <p-inputNumber [(ngModel)]="affectationForm.jours" mode="decimal" inputStyleClass="w-full" [min]="0"></p-inputNumber>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Annuler" icon="pi pi-times" text (onClick)="showAffectationDialog=false"></p-button>
    <p-button label="Enregistrer" icon="pi pi-check" (onClick)="saveAffectation()" severity="success"></p-button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Nouveau collaborateur"
  [(visible)]="showCollabDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
>
  <div class="form-grid">
    <label>Nom</label>
    <input pInputText type="text" [(ngModel)]="collabForm.nom" placeholder="Nom" />

    <label>Prénom</label>
    <input pInputText type="text" [(ngModel)]="collabForm.prenom" placeholder="Prénom" />

    <label>Coût (€)</label>
    <p-inputNumber [(ngModel)]="collabForm.cout" mode="decimal" inputStyleClass="w-full" [min]="0"></p-inputNumber>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Annuler" icon="pi pi-times" text (onClick)="showCollabDialog=false"></p-button>
    <p-button label="Ajouter" icon="pi pi-check" (onClick)="saveCollaborateur()" severity="success"></p-button>
  </ng-template>
</p-dialog>
